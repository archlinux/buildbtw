image: "archlinux:latest"

before_script:
  - pacman -Syu --needed --noconfirm rust gcc cargo-audit pkgconf sqlx-cli
  - sqlx db create
  - sqlx migrate run

variables:
  DATABASE_URL: "sqlite:buildbtw_server.sqlite"

stages:
  - lint
  - test

format:
  stage: lint
  script:
    - cargo fmt --all -- --check

clippy:
  stage: lint
  script:
    - cargo clippy --workspace --all-targets -- -D warnings

audit:
  stage: lint
  script:
    - cargo audit

test:
  stage: test
  script:
    - cargo test --workspace --release
