image: "archlinux:latest"

before_script:
  - pacman -Syu --needed --noconfirm rust gcc cargo-audit pkgconf sqlx-cli podman crun
  - sqlx db create
  - sqlx migrate run

variables:
  DATABASE_URL: "sqlite:buildbtw_server.sqlite"

stages:
  - check
  - build

format:
  stage: check
  script:
    - cargo fmt --all -- --check

audit:
  stage: check
  script:
    - cargo audit

.cache-rust:
  cache:
    key: ${CI_COMMIT_REF_SLUG}-${CI_JOB_NAME}

    paths:
      - .cargo/bin
      - .cargo/registry/index
      - .cargo/registry/cache
      - target/debug/deps
      - target/debug/build
      - target/release/deps
      - target/release/build
  variables:
    CARGO_HOME: ${CI_PROJECT_DIR}/.cargo

lint-test:
  stage: check
  extends: .cache-rust
  script:
    - cargo clippy --workspace --all-targets -- -D warnings
    - cargo test --workspace --release

build:
  stage: build
  extends: .cache-rust
  tags:
    - vm
  # For now, we're only publishing builds for the proof-of-concept.
  rules:
    - if: $CI_COMMIT_BRANCH == "proof-of-concept"
    - if: $CI_PIPELINE_SOURCE == "push"
  script:
    - cargo build --release
    - podman build --format docker --manifest buildbtw-server --file Containerfile --manifest registry.archlinux.org/archlinux/buildbtw:poc-server-latest target/release
    - echo "$CI_JOB_TOKEN" | podman login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
    - podman push registry.archlinux.org/archlinux/buildbtw:poc-server-latest
